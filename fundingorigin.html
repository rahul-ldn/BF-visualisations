<head>
  
<script src="Chart.bundle.min.js">
</script>
<script src="Chart.min.js"></script>
<script src="belmont-forum.style.js"> </script>
<script src="numeral.min.js"></script>
  <script src="chartjs-plugin-datalabels"></script>

</head>

<body>

  <div style='width: 1400; height: 1400;'>
  <canvas id="fundingorigins" ></canvas>
  </div>
  <script>
    
    
    
    //This array should be populated from BFGO data
    function FunderData() {
      var funderinfo = [
        ["BMBF",55],
        ["CNR",146],
        ["CSIRO", 257],
        ["DFG", 239],
        ["EC",  140],
        ["FAPESP",  175],
        ["Finland - Academy of Finland",50],
        ["Formas",  50],
        ["MESRI", 100],
        ["MEXT",  100],
        ["MINCyT",  20],
        ["MINECO",  40],
        ["MoES",  10],
        ["NERC",  375],
        ["NSERC", 299],
        ["NSF", 374],
        ["NSFC",  389],
        ["NWO", 27],
        ["RCN", 2],
        ["RFBR",  19],
        ["TUBITAK", 140]
      ];
      return funderinfo;
    }


  var fundingdata = FunderData();


// The number of projects in the CRA
  var numfunders = fundingdata.length;

   var funderlist = [];
  for (var i = 1; i <numfunders; i++) {
    funderlist.push(fundingdata[i][0]);
  }

  var funders = [];
  var funder_medium_colours = [];
  var funder_dark_colours = [];
  var funder_light_colours = [];
  var contribtotal = 0;
  var contributions = [];
  for (var i = 0; i < numfunders; i++){
    contributions[i] = fundingdata[i][1];
    contribtotal += contributions[i];
    funders[i] = fundingdata[i][0];
    funder_dark_colours[i] = BF_member_colour(funders[i],"dark");
    funder_medium_colours[i] = BF_member_colour(funders[i],"medium");
    funder_light_colours[i] = BF_member_colour(funders[i],"light");
//    document.write(projects + " "+rdata[i]+ " "+tdata[i] + "<BR>");
  }    
contribtotal = contribtotal+ ' K\u20AC';
    
     Chart.pluginService.register({
  beforeDraw: function(chart) {
    var width = chart.chart.width,
        height = chart.chart.height,
        ctx = chart.chart.ctx;

    ctx.restore();
    var fontSize = (height / 414).toFixed(2);
    ctx.font = fontSize + "em sans-serif";
    ctx.textBaseline = "middle";

    var text = "T2S Total: "+contribtotal,
        textX = Math.round((width - ctx.measureText(text).width) / 2),
        textY = height / 2;

    ctx.fillText(text, textX, textY);
    ctx.save();
  }
});

var ctx = document.getElementById("fundingorigins");
var myChart = new Chart(ctx, {
  type: 'doughnut',

  data: {
    labels: funders,
    datasets: [{
      data: contributions,
      backgroundColor: funder_medium_colours,
      borderColor: funder_dark_colours,
      borderWidth: 3,
      datalabels: {
            formatter : function(value, context) {
                var result = numeral(value).format('(0,0[.]]00 a)') + k_euro;
                return context.chart.data.labels[context.dataIndex]+': '+result;

            },
            backgroundColor: funder_dark_colours,
            //function(context) {
            //  return context.dataset.backgroundColor;
            //},
            borderColor: funder_medium_colours,
            borderRadius: 5,
            borderWidth: 0,
            anchor: 'end',
            align: 'end', 
            /*offset : function(context) {
              var total_arc = 0;
              var offset_variance = 10;
              for (arc = 0; arc < context.dataset.data.length; arc++) {
                total_arc += context.dataset.data[arc];
              };
              var pc_member_arc = context.dataset.data[context.dataIndex]/total_arc;
              if (pc_member_arc < 0.04) {
                var acronym = context.chart.data.labels[context.dataIndex];
                switch (context.dataIndex % 4) {
                  case 0 :
                    offset_variance += 0.5 * 40 ;
                    break;
                  case 1 :
                    offset_variance += -3.5 * 40 ;
                    break;
                  case 2 :
                    offset_variance += 1.5 * 40 ;
                    break;
                  case 3 :
                    offset_variance += -5.5 * 40 ;
                    break;

                }
                
                console.log(acronym+" Offset variance "+offset_variance);
              }
//              offset_variance = 20;
              return offset_variance;

            },*/
            rotation : function(context) {
              var acronym = context.chart.data.labels[context.dataIndex];
              var constraint = 0;
              var total_arc = 0;
              var preceding_arc = 0;
              for (arc = 0; arc < context.dataset.data.length; arc++) {
                total_arc += context.dataset.data[arc];
                if (acronym == context.chart.data.labels[arc]) {
                  constraint = 1;
                }
                if (!(constraint)) {
                  preceding_arc += context.dataset.data[arc];
                }
              };
              console.log(context.chart.data.labels[context.dataIndex]+" Index Value: "+context.dataIndex+" Arc Values: "+preceding_arc+" / "+total_arc);
              var pc_arc = 0.0 + ((preceding_arc + (context.dataset.data[context.dataIndex]/2)) *1000) / (total_arc *1000);
              var degree_arc = pc_arc * 360;
              console.log("Precentage of Arc: "+pc_arc+" Degree of Arc: "+degree_arc);
              var degree_rotation = 0;
              if ((degree_arc >= 0) && (degree_arc < 90)) {
                  degree_rotation = 270 + degree_arc;
                  console.log("Degree of Arc was "+degree_arc+"so Degree of Rotation is "+degree_rotation);
                };
              if ((degree_arc >=90) && (degree_arc < 180)) {
                  degree_rotation = degree_arc - 90;
                  console.log("Degree of Arc was "+degree_arc+"so Degree of Rotation is "+degree_rotation);
                };
              if ((degree_arc >=180)&&(degree_arc<270)) {
                  degree_rotation = degree_arc + 90
                  console.log("Degree of Arc was "+degree_arc+"so Degree of Rotation is "+degree_rotation);
                };
              if ((degree_arc >=270)&&(degree_arc<360)) {
                  degree_rotation = degree_arc -270;
                  console.log("Degree of Arc was "+degree_arc+"so Degree of Rotation is "+degree_rotation);
                };                 
              
              console.log(degree_rotation);
              return degree_rotation;

            },
            color: funder_light_colours,
            font: {
              weight: 'bold'
            }
       
          },
  }],
},
      
options: {
  layout: {
            padding: {
                left: 100,
                right: 100,
                top: 100,
                bottom: 100
            }
        },
    legend: {
    display: false,

  },
/* tooltips: {
    callbacks: {
      label: function(tooltipItem, data) {
                    return (data.labels[tooltipItem.datasetIndex] + ": " + numeral(tooltipItem.data).format('(0,0[.]]00 a)')+ k_euro)
                }
            }
        },*/
  cutoutPercentage: 85,
  animateRotate: "true"

}
}
);
  </script>
</body>
