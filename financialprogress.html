<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.7.0/dist/Chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>

 <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
     <script src="https://rahulsindc.github.io/BF-visualisations/belmont-forum.style.js"> </script>

 <style>
   .financialprogressprojectlist {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
    width: 100%;
}    .financialprogressprojectlist select {
        font-family: 'Arial';
        display: inline-block;
        width: 100%;
        cursor: pointer;
        padding: 10px 15px;
        outline: 0;
        border: 0px solid #808080;
        border-radius: 0px;
        background: #808080;
        color: #FFFFFF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }
        .financialprogressprojectlist select::-ms-expand {
            display: none;
        }
        .financialprogressprojectlist select:hover,
        .financialprogressprojectlist select:focus {
            color: white;
            background: #808080;
        }
        .financialprogressprojectlist select:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
.financialprogressprojectlist_arrow {
    position: absolute;
    top: 10px;
    right: 15px;
    width: 0;
    height: 0;
    border: solid white;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 3px;
    transform: rotate(45deg);
    -webkit-transform: rotate(45deg);
}
.financialprogressprojectlist select:hover ~ .financialprogressprojectlist_arrow,
.financialprogressprojectlist select:focus ~ .sfinancialprogressprojectlist_arrow {
    border-top-color: #808080;
}
.financialprogressprojectlist select:disabled ~ .financialprogressprojectlist_arrow {
    border-top-color: #808080;
}
 </style>

</head>

<body>
   
  Member funding per Project <div id="financialprogressprojectlist" class="financialprogressprojectlist" style="width: 300"><div class="financialprogressprojectlist_arrow"></div></div><BR>
  (Areas with a lighter shade represent funding commitments as yet undisbursed)<br><BR><BR>
  <canvas id="financialprogress" height="600" width="600"></canvas>

  <script>
    
    
    
    //This array should be populated from BFGO data
    function financialprogressinformation() {

      var dummydata = [
            ["TAMANI", "Designing an Improved Network of Long-Term Monitor\u2026ommunities through Participatory Science Programs", "NSFC", "China - National Natural Science Foundation of China (NSFC)", 0, 4, "MINECO", "Spain - Ministry of Economy and Competitiveness (MINECO)", 40, 40, "NWO", "The Netherlands - The Netherlands Organisation for Scientific Research (NWO)", 14, 14, "NSF", "United States - National Science Foundation (NSF)", 44, 44, 98, 102]
          ,["ASUS", "Arctic Sustainability: A Synthesis of Knowledge", "FAPESP", "Brazil - São Paulo Research Foundation (FAPESP)", 40, 40, "NSFC", "China - National Natural Science Foundation of China (NSFC)", 0, 137, "BMBF", "Germany - Federal Ministry of Education and Research (BMBF)", 0, 43, "NERC", "United Kingdom - Natural Environment Research Council (NERC)", 25, 25, "NSF", "United States - National Science Foundation (NSF)", 50, 50, 115, 295]
          ,["CONNECT", "Global Connections and Changing Resource Use System in the Arctic", "CSIRO", "Australia - The Commonwealth Scientific and Industrial Research Organisation (CSIRO)", 0, 107, "NSERC", "Canada - The Natural Sciences and Engineering Research Council of Canada (NSERC)", 100, 100, "DFG", "Germany - German Research Foundation (DFG)", 0, 149, "NSF", "United States - National Science Foundation (NSF)", 100, 100, 200, 456]
          ,["RACArctic", "Resilience and Adaptive Capacity of ARCTIC Marine Systems Under a Changing Climate", "NSERC", "Canada - The Natural Sciences and Engineering Research Council of Canada (NSERC)", 0, 149, "NSFC", "China - National Natural Science Foundation of China (NSFC)", 0, 237, "MoES", "India - Ministry of Earth Sciences (MoES)", 10, 10, "NERC", "United Kingdom - Natural Environment Research Council (NERC)", 200, 200, 210, 596]
          ,["ARCTIC-ERA", "Arctic Climate Change and its Impact on Environment, Infrastructures, and Resource Availability", "MEXT", "Japan - Ministry of Education, Culture, Sports, Science and Technology (MEXT)", 100, 100, "Formas", "Sweden - The Swedish Research Council (Formas)", 50, 50, "NWO", "The Netherlands - The Netherlands Organisation for Scientific Research (NWO)", 0, 13, "TUBITAK", "Turkey - The Scientific and Technological Research Council of Turkey (TUBITAK)", 100, 100, 250, 263]
          ,["BAAMRGP", "Bio-Economic Analysis for Arctic Marine Resource Governance and Policy", "MINCyT", "Argentina - Ministry of Science, Technology and Productive Innovation (MINCyT)", 20, 20, "MESRI", "France - Ministry of Higher Education, Research and Innovation (MESRI)", 100, 100, "RFBR", "Russia - Russian Foundation for Basic Research (RFBR)", 0, 7, "NERC", "United Kingdom - Natural Environment Research Council (NERC)", 75, 100, "NSF", "United States - National Science Foundation (NSF)", 100, 100, 295, 327]
          ,["COPERA", "C budget of Ecosystems, Cities and Villages on Permafrost in the Eastern Russian Arctic", "CSIRO", "Australia - The Commonwealth Scientific and Industrial Research Organisation (CSIRO)", 150, 150, "NSFC", "China - National Natural Science Foundation of China (NSFC)", 0, 11, "BMBF", "Germany - Federal Ministry of Education and Research (BMBF)", 0, 12, "DFG", "Germany - German Research Foundation (DFG)", 40, 40, "NERC", "United Kingdom - Natural Environment Research Council (NERC)", 50, 50, 240, 263]
          ,["HIARC", "Anthropogenic Heat Islands in the Arctic: Windows \u2026 the Regional Climates, Ecosystems, and Societies", "FAPESP", "Brazil - São Paulo Research Foundation (FAPESP)", 0, 10, "EC", "European Union - European Commission (EC)", 50, 50, "RCN", "Norway - Research Council of Norway (RCN)", 0, 2, "TUBITAK", "Turkey - The Scientific and Technological Research Council of Turkey (TUBITAK)", 40, 40, "NSF", "United States - National Science Foundation (NSF)", 80, 80, 170, 182]
          ,["Pan-Arctic Options", "Holistic Integration for Arctic Coastal-Marine Sustainability", "FAPESP", "Brazil - São Paulo Research Foundation (FAPESP)", 0, 125, "NSERC", "Canada - The Natural Sciences and Engineering Research Council of Canada (NSERC)", 50, 50, "EC", "European Union - European Commission (EC)", 90, 90, "Finland - Academy of Finland", "Finland - Academy of Finland", 50, 50, "DFG", "Germany - German Research Foundation (DFG)", 0, 50, "CNR", "Italy - National Research Council (CNR)", 0, 146, "RFBR", "Russia - Russian Foundation for Basic Research (RFBR)", 0, 12, 190, 523]
                ];
      return dummydata;
    }

  financialprogresslabels = [];
  lightfinancialprogresscolours = [];
  darkfinancialprogresscolours = [];
  financialprogressundisbursed = [];
  financialprogressdisbursed = [];
  financialprogresstotal = [];
  funderlist = [];
  console.log("BEGINS");
  rawfinancialprogressdata = financialprogressinformation();
  var projectselecting = document.getElementById("financialprogressprojectlist");
  var selectcontrol = document.createElement("select");
  selectcontrol.id = "ProjectSelected";
  projectselecting.appendChild(selectcontrol);
  
  // All Projects loop: Here we populate all variables and take all actions that initialise on all projects' data

  for (var currentproject = 0; currentproject < rawfinancialprogressdata.length; currentproject ++) {
    console.log("Project Loop: " + currentproject + " out of "+ rawfinancialprogressdata.length);
 //array of funderlist per project, 2nd dimension 0 name 1 commitment 2 disbursed
    financialprogresslabels[currentproject] = [];
    lightfinancialprogresscolours[currentproject] = [];
    darkfinancialprogresscolours[currentproject] = [];
    financialprogressundisbursed[currentproject] = [];
    financialprogressdisbursed[currentproject] = [];
    financialprogresstotal[currentproject]=[];
    funderlist[0]=[];
    for (var funderdata = 2; funderdata < (rawfinancialprogressdata[currentproject].length-2); funderdata++) {
      funderdataoffset = (funderdata -2) % 4;
      
      currentfunder = (((funderdata -2) - funderdataoffset)/ 4); //This _should_ correspond to the initial dimension index for funderlist[][]
      rfpd_pop = rawfinancialprogressdata[currentproject][funderdata];
      console.log("Loop Count: "+ funderdata + " out of " + rawfinancialprogressdata[currentproject].length +" Funder Data Offset: " + funderdataoffset +" Current Funder: "+currentfunder+" ("+rawfinancialprogressdata[currentproject][2+(currentfunder*4)]+") Current Data: "+ rfpd_pop+ " Raw: "+rawfinancialprogressdata[currentproject]);

  
      if (funderdataoffset === 0 ) { 
        var lightcolour = BF_member_colour(rfpd_pop, "light");
        var darkcolour = BF_member_colour(rfpd_pop, "dark");
        console.log("Colour attempt with "+rfpd_pop+" L: "+lightcolour+" D: "+darkcolour);
          financialprogresslabels[currentproject][currentfunder]=rfpd_pop;
          lightfinancialprogresscolours[currentproject][currentfunder] = lightcolour;
          darkfinancialprogresscolours[currentproject][currentfunder] = darkcolour;
          funderlist[currentfunder][0]=rfpd_pop;
        };
      if (funderdataoffset === 1 ) { console.log("We can't use it, so: "+rfpd_pop);};
      if (funderdataoffset === 2 ) { 
          financialprogresstotal[currentproject][currentfunder]=rfpd_pop;
          funderlist[currentfunder][1]=rfpd_pop;
        };
      if (funderdataoffset === 3 ) { 
          financialprogressdisbursed[currentproject][currentfunder]=rfpd_pop;
      //    financialprogresstotal[currentproject][currentfunder] = "(Total Commitment: "+numeral(financialprogressundisbursed[currentproject][currentfunder]).format('($0,0[.]]00 a)')+")";
          financialprogressundisbursed[currentproject][currentfunder] = rfpd_pop-financialprogresstotal[currentproject][currentfunder];

          funderlist[currentfunder][2]=rfpd_pop;
        console.log("Name: "+funderlist[currentfunder][0]+" Committed: "+funderlist[currentfunder][1]+" Disbursed: "+funderlist[currentfunder][2]);


        funderlist[currentfunder+1]=[];
    }
    } //funderlist[][] populated for current project, radio buttons constructed

        var option = document.createElement("option");
        option.setAttribute("value", currentproject);
        option.text = rawfinancialprogressdata[currentproject][0];
        selectcontrol.appendChild(option);

  }//project loop
  currentproject = 0;
  


   /* Chart.helpers.merge(Chart.defaults.global, {
      maintainAspectRatio: false,
      tooltips: false,
      layout: {
        padding: 32
      },
      elements: {
        line: {
          fill: false
        },
        point: {
          hoverRadius: 7,
          radius: 5
        }
      },
      plugins: {
        legend: false,
    //    title: false
      }
    });

    Chart.pluginService.register({
  beforeDraw: function(chart) {
    var width = chart.chart.width,
        height = chart.chart.height,
        ctx = chart.chart.ctx;

    ctx.restore();
    var fontSize = (height / 414).toFixed(2);
    ctx.font = fontSize + "em sans-serif";
    ctx.textBaseline = "middle";

    var text = "T2S Total: "+contribtotal,
        textX = Math.round((width - ctx.measureText(text).width) / 2),
        textY = height / 2;

    ctx.fillText(text, textX, textY);
    ctx.save();
  }
});
*/
console.log("Raw Labels: "+financialprogresslabels);
console.log("Raw Undisbursed: "+financialprogressundisbursed);
console.log("Raw Disbursed: "+financialprogressdisbursed);
console.log("Raw Colours: ");
console.log(darkfinancialprogresscolours);

var ctx = document.getElementById("financialprogress").getContext('2d');
var config = {
type: 'bar',
    data: {
      labels : financialprogresslabels[0],
      datasets : [
       {
           label : "Released to Project",
           data: financialprogressdisbursed[0],
            datalabels: {

              align: 'center',
              anchor: 'center',
              formatter : function(value, context) {
                var result = numeral(value).format('($0,0[.]0 a)');
                return result;

                },
              backgroundColor: function(context) {
                return context.dataset.backgroundColor;
              },
              borderColor: 'white',
              borderRadius: 15,
              borderWidth: 1,
              color: 'white',
              font: {
                weight: 'bold'
              }
       
          
            },
           backgroundColor: darkfinancialprogresscolours[0],
//           hoverBackgroundColor: "#214C26",
//           hoverBorderWidth: 8,
           borderWidth : 4,
           borderColor: darkfinancialprogresscolours[0],
 //          hoverBorderColor: "#214C26"
        },
        {
           label : "Undisbursed",
            data: financialprogressundisbursed[0],
            datalabels: {

              align: 'center',
              anchor: 'center',
              formatter : function(value, context) {
                var result = numeral(value).format('($0,0[.]0 a)');
                return result;

              },
              backgroundColor: function(context) {
                return context.dataset.backgroundColor;
              },
              borderColor: 'white',
              borderRadius: 15,
              borderWidth: 1,
              color: 'white',
              font: {
                weight: 'bold'
              }
       
          
            },

           backgroundColor: lightfinancialprogresscolours[0],
           borderColor: darkfinancialprogresscolours[0],
           borderWidth : 4,
 //          hoverBackgroundColor: "#D2F2D7",
  //         hoverBorderWidth: 8,
   //        hoverBorderColor: "#214C26",
           borderSkipped: false
        },
       
        ]
    },
    options: {
        responsive: false,
        animation: {
          duration: 500,
        },
        tooltips: {
          mode: 'label',
          callbacks: {
          label: function(tooltipItem, data) { 
            return data.datasets[tooltipItem.datasetIndex].label + ": " + numeral(tooltipItem.yLabel).format('($0,0[.]]00 a)');
          }
          }
         },

        plugins: {
          datalabels: {
            color: 'white',
            display: function(context) {
              return context.dataset.data[context.dataIndex] > 2;
            },
            font: {
              weight: 'bold'
            },
            formatter: Math.round
          }
        },
        scales: {
          xAxes: [{ 
            stacked: true, 
            gridLines: { display: false },
          //  barThickness : 140,
            categoryPercentage: 0.9,
            barPercentage: 1.0,
  //          ticks: {
    //          callback: function(value, index, values) {
      //          console.log("value "+value+"index "+index+"values "+values);
        //        var newtick = value+" (Total Committed: "+numeral(financialprogresstotal[index]).format('($0,0[.]]00 a)')+")";
          //      return newtick; 
            //  },
          //  }
            }],
          yAxes: [{ 
            stacked: true, 
            ticks: {
              beginAtZero: true,
              callback: function(value, index, values) { return numeral(value).format('($0,0[.]]00 a)'); },
            }, 
            }],
        }, // scales
        legend: {
          display: false,
          labels: {
            fontSize: 14,
            fontStyle: 'bold',
          }
        }
    }
};
var financialprogresschart = new Chart(ctx, config);
$("#financialprogressprojectlist").change(function() {
    var selectedproject = document.getElementById("ProjectSelected");
    currentproject = selectedproject.selectedIndex;
    console.log("Select New Project: "+currentproject);
    var data = financialprogresschart.config.data;
    data.datasets[0].data = financialprogressdisbursed[currentproject];
    data.datasets[1].data = financialprogressundisbursed[currentproject];
    data.datasets[0].backgroundColor = darkfinancialprogresscolours[currentproject];
    data.datasets[0].borderColor = darkfinancialprogresscolours[currentproject];
    data.datasets[1].backgroundColor = lightfinancialprogresscolours[currentproject];
    data.datasets[1].borderColor = darkfinancialprogresscolours[currentproject];
    data.labels = financialprogresslabels[currentproject];
    financialprogresschart.update();
});



  </script>
</body>

