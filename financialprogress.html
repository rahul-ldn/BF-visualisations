<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.7.0/dist/Chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>

 <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
     <script src="https://rahulsindc.github.io/BF-visualisations/belmont-forum.style.js"> </script>

 <style>
   .financialprogressprojectlist {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
    width: 100%;
}    .financialprogressprojectlist select {
        font-family: 'Arial';
        display: inline-block;
        width: 100%;
        cursor: pointer;
        padding: 10px 15px;
        outline: 0;
        border: 0px solid #808080;
        border-radius: 0px;
        background: #808080;
        color: #FFFFFF;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }
        .financialprogressprojectlist select::-ms-expand {
            display: none;
        }
        .financialprogressprojectlist select:hover,
        .financialprogressprojectlist select:focus {
            color: white;
            background: #808080;
        }
        .financialprogressprojectlist select:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
.financialprogressprojectlist_arrow {
    position: absolute;
    top: 10px;
    right: 15px;
    width: 0;
    height: 0;
    border: solid white;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 3px;
    transform: rotate(45deg);
    -webkit-transform: rotate(45deg);
}
.financialprogressprojectlist select:hover ~ .financialprogressprojectlist_arrow,
.financialprogressprojectlist select:focus ~ .sfinancialprogressprojectlist_arrow {
    border-top-color: #808080;
}
.financialprogressprojectlist select:disabled ~ .financialprogressprojectlist_arrow {
    border-top-color: #808080;
}
 </style>

</head>

<body>
   
  Member funding per Project <div id="financialprogressprojectlist" class="financialprogressprojectlist" style="width: 300"><div class="financialprogressprojectlist_arrow"></div></div><BR>
  (Lighter shade represents funding commitments as yet undisbursed)<br><BR><BR>
  <canvas id="financialprogress" height="600" width="700"></canvas>

  <script>
    
    
    
    //This array should be populated from BFGO data
    function financialprogressinformation() {

      var sourceData = [
        [26,"TAMANI","Designing an Improved Network of Long-Term Monitoring Sites for Arctic Vertebrates: Towards a Better Involvement of Local Communities through Participatory Science Programs",150.0,130.0],
        [27,"ASUS","Arctic Sustainability: A Synthesis of Knowledge",295.0,227.0],
        [28,"CONNECT","Global Connections and Changing Resource Use System in the Arctic",456.0,311.0],
        [29,"RACArctic","Resilience and Adaptive Capacity of ARCTIC Marine Systems Under a Changing Climate",596.0,410.0],
        [30,"AFV","Arctic Fog Variability in a Warming Arctic and its Impact on Maritime Human Activities",391.0,309.0],
        [31,"ARCTIC-ERA","Arctic Climate Change and its Impact on Environment, Infrastructures, and Resource Availability",263.0,234.0],
        [32,"BAAMRGP","Bio-Economic Analysis for Arctic Marine Resource Governance and Policy",347.0,313.0],
        [33,"COPERA","C budget of Ecosystems, Cities and Villages on Permafrost in the Eastern Russian Arctic",263.0,230.0],
        [34,"HIARC","Anthropogenic Heat Islands in the Arctic: Windows to the Future of the Regional Climates, Ecosystems, and Societies",182.0,167.0],
        [35,"Pan-Arctic Options","Holistic Integration for Arctic Coastal-Marine Sustainability",523.0,267.0],
        [-1," "," ",-1,-1],
        [26,"FAPESP","São Paulo Research Foundation",48.0,29.0],
        [26,"MINECO","Ministry of Economy and Competitiveness",40.0,40.0],
        [26,"NSF","National Science Foundation",44.0,44.0],
        [26,"NSFC","National Natural Science Foundation of China",4.0,3.0],
        [26,"NWO","The Netherlands Organisation for Scientific Research",14.0,14.0],
        [27,"DLR","German Aerospace Center"," ",14.0],
        [27,"FAPESP","São Paulo Research Foundation",40.0,22.0],
        [27,"NERC","Natural Environment Research Council",25.0,25.0],
        [27,"NSF","National Science Foundation",50.0,50.0],
        [27,"NSFC","National Natural Science Foundation of China",137.0,116.0],
        [28,"DFG","German Research Foundation",149.0,111.0],
        [28,"NSERC","The Natural Sciences and Engineering Research Council of Canada",100.0,100.0],
        [28,"NSF","National Science Foundation",100.0,100.0],
        [29,"MoES","Ministry of Earth Sciences",10.0,10.0],
        [29,"NERC","Natural Environment Research Council",200.0,200.0],
        [29,"NSERC","The Natural Sciences and Engineering Research Council of Canada",149.0,100.0],
        [29,"NSFC","National Natural Science Foundation of China",237.0,100.0],
        [30,"BMBF","Federal Ministry of Education and Research",11.0,9.0],
        [30,"ESRC","Economic and Social Research Council",130.0,50.0],
        [30,"Innoviris","Innoviris",40.0,40.0],
        [30,"MoES","Ministry of Earth Sciences",10.0,10.0],
        [30,"NERC","Natural Environment Research Council",200.0,200.0],
        [31,"Formas","The Swedish Research Council",50.0,22.0],
        [31,"MEXT","Ministry of Education, Culture, Sports, Science and Technology",100.0,100.0],
        [31,"NWO","The Netherlands Organisation for Scientific Research",13.0,12.0],
        [31,"TUBITAK","The Scientific and Technological Research Council of Turkey",100.0,100.0],
        [32,"CSIRO","The Commonwealth Scientific and Industrial Research Organisation",20.0,15.0],
        [32,"MESRI","Ministry of Higher Education, Research and Innovation",100.0,100.0],
        [32,"MINCyT","Ministry of Science, Technology and Productive Innovation",20.0,20.0],
        [32,"NERC","Natural Environment Research Council",100.0,75.0],
        [32,"NSF","National Science Foundation",100.0,100.0],
        [32,"RFBR","Russian Foundation for Basic Research",7.0,3.0],
        [33,"CSIRO","The Commonwealth Scientific and Industrial Research Organisation",150.0,129.0],
        [33,"DFG","German Research Foundation",40.0,40.0],
        [33,"NERC","Natural Environment Research Council",50.0,50.0],
        [33,"NSFC","National Natural Science Foundation of China",11.0,11.0],
        [34,"EC","European Commission",50.0,45.0],
        [34,"NSF","National Science Foundation",80.0,80.0],
        [34,"RCN","Research Council of Norway",2.0,2.0],
        [34,"TUBITAK","The Scientific and Technological Research Council of Turkey",40.0,40.0],
        [35,"Academy of Finland","Academy of Finland",50.0,50.0],
        [35,"DFG","German Research Foundation",50.0,27.0],
        [35,"EC","European Commission",90.0,90.0],
        [35,"FAPESP","São Paulo Research Foundation",125.0,50.0],
        [35,"NSERC","The Natural Sciences and Engineering Research Council of Canada",50.0,50.0]
      ];
      return sourceData;

    };


    var query_data = financialprogressinformation();


    function member_exists (memberlist, member_short) {
 //         console.log("Checking "+member_short);
 //         console.log(memberlist);
      for (var current_member = 0; current_member < memberlist.length; current_member++) {
//        console.log(member_short + " vs " +memberlist[current_member][0]);
       if ( member_short == memberlist[current_member][0] ) {
         console.log(member_short+" Does Exist!");
         return 1;
         break;
       }
     };
     console.log(member_short+" Doesn't Exist!");
     return 0;
   }
   function member_lookup (memberlist, member_short) {
     for (var current_member = 0; current_member < memberlist.length; current_member++) {
       if (memberlist[current_member][0] == member_short) {
         console.log(member_short+" converted to "+memberlist[current_member][1]);
         return memberlist[current_member][1];
       }
     }
     console("Somehow project not found!!! "+projectid);
     return -1;
   }
   function project_lookup (lookup_table, projectid) {
     for (var current_project = 0; current_project < lookup_table.length; current_project++) {
       if (lookup_table[current_project][0] == projectid) {
         return lookup_table[current_project][1];
       }
     }
     console("Somehow project not found!!! "+projectid);
     return -1;
   }
 
  project_total = 0;
  project_table = [[0,0]];
  projects_short = [];
  projects_long = [];
  members_short = [];
  members_long = [];
  member_commitments = [];
  member_disbursals = [];
  member_undisbursed = [];
  member_excess = [];
  members_colour_dark = [];
  members_colour_light = [];

  
  console.log("BEGINS");

  var projectselecting = document.getElementById("financialprogressprojectlist");
  var selectcontrol = document.createElement("select");
  selectcontrol.id = "ProjectSelected";
  projectselecting.appendChild(selectcontrol);


while (query_data[project_total][0] != -1) {
    project_table[project_total]= [query_data[project_total][0],project_total];
    projects_short[project_total] = query_data[project_total][1];
    projects_long[project_total] = query_data[project_total][2];
    console.log("Current Project Total: "+project_total);
    members_short[project_total] = [];
    members_long[project_total] = [];
    member_commitments[project_total] = [];
    member_disbursals[project_total] = [];
    member_undisbursed[project_total] = [];
    member_excess[project_total] = [];
    members_colour_dark[project_total] = [];
    members_colour_light[project_total] = [];
    project_total++;
 }

for (var current_data_line = (project_total +1); //skip the break line
      current_data_line < query_data.length; 
      current_data_line++){
  if ((query_data[current_data_line][3] == " ") || (query_data[current_data_line][3] == "")) {
    query_data[current_data_line][3] = 0;
  }
  var current_project = project_lookup(project_table,query_data[current_data_line][0]);
  members_short[current_project].push(query_data[current_data_line][1]);
  members_long[current_project].push(query_data[current_data_line][2]);
  member_commitments[current_project].push(query_data[current_data_line][3]);
  member_disbursals[current_project].push(query_data[current_data_line][4]);
  members_colour_dark[current_project].push(BF_member_colour(members_short[current_project][(members_short[current_project].length - 1)],"dark"))
  members_colour_light[current_project].push(BF_member_colour(members_short[current_project][(members_short[current_project].length - 1)],"light"))
  var undisbursed = (member_commitments[current_project][ (member_commitments[current_project].length - 1)] - member_disbursals[current_project][ (member_disbursals[current_project].length - 1)]);
  console.log("At CDL "+current_data_line+" on project "+current_project+" calculated undisbursed value is "+undisbursed);
  if (undisbursed < 0 ) {
    undisbursed = Math.abs(undisbursed);
    member_undisbursed[current_project].push(0);
    member_excess[current_project].push(undisbursed);
    member_disbursals[current_project][(member_disbursals[current_project].length-1)] = member_disbursals[current_project][(member_disbursals[current_project].length-1)] - undisbursed;  //Why is this double subtracting? 
  } else {
    member_undisbursed[current_project].push(undisbursed);
    member_excess[current_project].push(0);
  }
};
for (var current_project = 0; current_project < project_total; current_project++) {
  var option = document.createElement("option");
  option.setAttribute("value", current_project);
  option.text = projects_long[current_project];
  selectcontrol.appendChild(option);
}

console.log("Raw Labels: ");
console.log(members_short);
console.log("Raw Undisbursed: ");
console.log(member_undisbursed)
console.log("Raw Disbursed: ");
console.log(member_disbursals);
console.log("Raw Colours: ");
console.log(members_colour_dark);

var ctx = document.getElementById("financialprogress").getContext('2d');
var config = {
type: 'bar',
    data: {
      labels : members_short[0],
      datasets : [
       {
          label : "Released to Project",
          data: member_disbursals[0],
          datalabels: {
            align: 'center',
            anchor: 'center',
            formatter : function(value, context) {
              var result = numeral(value).format('(0,0[.]0 a)') + 'K \u20AC';
              return result;

            },
            backgroundColor: function(context) {
              return context.dataset.backgroundColor;
            },
            borderColor: 'white',
            borderRadius: 15,
            borderWidth: 1,
            color: 'white',
            font: {
              weight: 'bold'
            }         
          },
          backgroundColor: members_colour_dark[0],
//           hoverBackgroundColor: "#214C26",
//           hoverBorderWidth: 8,
          borderWidth : 4,
          borderColor: members_colour_dark[0],
 //          hoverBorderColor: "#214C26"
        },
        {
          label : "Undisbursed",
          data: member_undisbursed[0],
          datalabels: {
            align: 'center',
            anchor: 'center',
            formatter : function(value, context) {
              var result = numeral(value).format('(0,0[.]0 a)') + 'K \u20AC';
              return result;
            },
            backgroundColor: function(context) {
              return context.dataset.backgroundColor;
            },
            borderColor: 'white',
            borderRadius: 15,
            borderWidth: 1,
            color: 'white',
            font: {
              weight: 'bold'
            }
      
        
          },
          backgroundColor: members_colour_light[0],
          borderColor: members_colour_dark[0],
          borderWidth : 4,
//         hoverBackgroundColor: "#D2F2D7",
 //        hoverBorderWidth: 8,
  //       hoverBorderColor: "#214C26",
          borderSkipped: false
        },
        {
          label : "Extra Funds Beyond Commitment",
          data: member_excess[0],
          datalabels: {
            align: 'center',
            anchor: 'center',
            formatter : function(value, context) {
              var result = numeral(value).format('(0,0[.]0 a)') + 'K \u20AC';
              return result;

            },
            backgroundColor: function(context) {
              return context.dataset.backgroundColor;
            },
            borderColor: 'white',
            borderRadius: 15,
            borderWidth: 1,
            color: 'white',
            font: {
              weight: 'bold'
            }         
          },
          backgroundColor: members_colour_dark[0],
//           hoverBackgroundColor: "#214C26",
//           hoverBorderWidth: 8,
          borderWidth : 4,
          borderColor: members_colour_dark[0],
 //          hoverBorderColor: "#214C26"
        },
       
        ]
    },
    options: {
        responsive: false,
        animation: {
          duration: 500,
        },
        tooltips: {
          mode: 'label',
          callbacks: {
          label: function(tooltipItem, data) { 
            return data.datasets[tooltipItem.datasetIndex].label + ": " + numeral(tooltipItem.yLabel).format('(0,0[.]]00 a)') + 'K \u20AC';
          }
          }
         },

        plugins: {
          datalabels: {
            color: 'white',
            display: function(context) {
              return context.dataset.data[context.dataIndex] > 2;
            },
            font: {
              weight: 'bold'
            },
            formatter: Math.round
          }
        },
        scales: {
          xAxes: [{ 
            stacked: true, 
            gridLines: { display: false },
          //  barThickness : 140,
            categoryPercentage: 0.9,
            barPercentage: 1.0,
  //          ticks: {
    //          callback: function(value, index, values) {
      //          console.log("value "+value+"index "+index+"values "+values);
        //        var newtick = value+" (Total Committed: "+numeral(financialprogresstotal[index]).format('($0,0[.]]00 a)')+")";
          //      return newtick; 
            //  },
          //  }
            }],
          yAxes: [{ 
            stacked: true, 
            ticks: {
              beginAtZero: true,
              callback: function(value, index, values) { return numeral(value).format('(0,0[.]]00 a)') + 'K \u20AC'; },
            }, 
            }],
        }, // scales
        legend: {
          display: false,
          labels: {
            fontSize: 14,
            fontStyle: 'bold',
          }
        }
    }
};
var financialprogresschart = new Chart(ctx, config);
$("#financialprogressprojectlist").change(function() {
    var selectedproject = document.getElementById("ProjectSelected");
    current_project = selectedproject.selectedIndex;
    console.log("Select New Project: "+current_project);
    var data = financialprogresschart.config.data;
    data.datasets[0].data = member_disbursals[current_project];
    data.datasets[1].data = member_undisbursed[current_project];
    data.datasets[2].data = member_excess[current_project];
    data.datasets[0].backgroundColor = members_colour_dark[current_project];
    data.datasets[0].borderColor = members_colour_dark[current_project];
    data.datasets[1].backgroundColor = members_colour_light[current_project];
    data.datasets[1].borderColor = members_colour_dark[current_project];
    data.datasets[2].backgroundColor = members_colour_light[current_project];
    data.datasets[2].borderColor = members_colour_dark[current_project];
    data.labels = members_short[current_project];
    financialprogresschart.update();
});



  </script>
</body>
